<!DOCTYPE html>
<html>
<head>
	
	<title>Mappa catasto Urbano</title>

    <meta charset="utf-8" />
    <meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no' />

    <link rel="stylesheet" href="./javascript/Control.OSMGeocoder.css" />
    <link rel="stylesheet" href="./javascript/leaflet.css"/>

    <script src="./javascript/leaflet.js"></script>
    <script src="./javascript/jquery-1.11.3.min.js"></script>
    
    <script src="./javascript/Control.OSMGeocoder.js"></script>


    <style>
        body {
            margin: 0;
            padding: 0;
        }
        #map {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 100%;
        }
        #autore, #export {
            position: absolute;
            top:50px;
            right:10px;
            z-index:500;
            background:white;
            color:black;
            padding:6px;
            border-radius:4px;
            font-family: 'Helvetica Neue';
            cursor: pointer;
            font-size:12px;
            text-decoration:none;
        }
        #export {
            top:90px;
        }
        #autore {
            background:black;
            color:white;
        }

        .info {top:150px; padding: 6px 8px; font: 14px/16px Arial, Helvetica, sans-serif; background: white; background: rgba(255,255,255,0.8); box-shadow: 0 0 15px rgba(0,0,0,0.2); border-radius: 5px; } .info h4 { margin: 0 0 5px; color: #777; }
    </style>




</head>
<body>

<script language="JavaScript">

    function getPara()
    {
        var parameters = location.search.substring(1).split("&");
        //alert(parameters);
        var temp = parameters[0].split("=");
        geojsonfile = unescape(temp[1]);
//alert(geojsonfile);
    }

getPara();
</script>



<div id='map'></div>
<a href='#' id='export'>Esporta Elementi</a>
<a href='https://github.com/marcobra/opencatamap' target=_blank id='autore'>Info</a>
<!--<div id='fondo'></div>Autore Marco Braida <a href='../form.html'>Ricerche</a>-->

<script src="leaflet-providers.js"></script>

<script>
	
	var myStyle = {
    "color": "#ff0000",
    "weight": 1,
    "opacity": 0.75
};

var osmTiles = L.tileLayer.provider('OpenStreetMap');
var osmgrigio  = L.tileLayer.provider('OpenStreetMap.BlackAndWhite');
var esriworld  = L.tileLayer.provider('Esri.WorldImagery');

// attivare e modificare solo nel caso non si vedano le custom tiles CTR
//var minx="8.58158510341350"
//var miny="44.37362932551235"
//var maxx="8.74939895901150"
//var maxy="44.47451414351876"


/*
var ctr= L.tileLayer('../cust_tiles/ctr/{z}/{x}/{y}.png', {
       //noWrap: true,
       crs: L.CRS.EPSG3857,
       tms: true   
       //bounds: [[miny,minx],[maxy,maxx]]
    }).setOpacity(0.4)
*/


// copiata impostazione da html generato da qgis2web
var ctr =L.tileLayer('http://cxc.altervista.org/tile/cust_tiles/ctr/{z}/{x}/{y}.png', {
        maxZoom: 18,
        tms: false,
        attribution: 'Generated by QTiles'
      })
//.addTo(map);


/*
var realVista = L.tileLayer.wms("http://213.215.135.196/reflector/open/service?", {
            layers: 'rv1',
            format: 'image/jpeg',attribution: 'RealVista1.0 WMS OPEN di <a href="http://www.realvista.it">e-GEOS SpA</a>'
        });
*/


var map = L.map('map', {
    center: [41.886,12.744],
    zoom: 6,
    layers: [ osmTiles ]
});

var baseMaps = {
    
    //"Satellite e-geos RealVista": realVista,
    
};


var overlayMaps = {
    "Sat esri world": esriworld,
    "Carta tecnica Regionale" : ctr,
    "Openstreetmap": osmTiles
};

// imposto opacita' dei layer
esriworld.setOpacity(0.5);
osmTiles.setOpacity(0.5);

L.control.layers(baseMaps,overlayMaps).addTo(map);


var osmGeocoder = new L.Control.OSMGeocoder({
            collapsed: false,
            position: 'bottomright',
            text: 'Ricerca via e civico!'
     });
osmGeocoder.addTo(map);



// provo ad impostare lo stile per la selezione
var geostyle = {
    "color": "#FFFF00",
    "weight": 4,
    "margin":5,
    "opacity": 0.55,
    "fillColor":"white",
    "fillOpacity":0.01
};

 
 var mygeojson = ""; 
    
  $.getJSON(geojsonfile, function(data) { addDataToMap(data, map); });




    function addDataToMap(data, map) {
        mygeojson = L.geoJson(data, { style: geostyle, 
        onEachFeature: function(feature, layer) {
            var popupText = "<b>Foglio:</b> " + feature.properties.Foglio
                + "<br><b>Mappale:</b> " + feature.properties.Mappale
                + "<br><b>sub:</b> " + feature.properties.sub
                + "<br><b>indirizzo:</b> " + feature.properties.indirizzo
                + "<br><b>titolo:</b> " + feature.properties.titolo
                + "<br><b>zona:</b> " + feature.properties.zona
                + "<br><b>categoria:</b> " + feature.properties.cat
                + "<br><b>consistenza:</b> " + feature.properties.cons
                + "<br><b>piano:</b> " + feature.properties.piano   
                + "<br><b>rendita:</b> " + feature.properties.rendita
                + "<br><b>idImmobile:</b> " + feature.properties.idImm
                + "<br>"
                + "<br><b><a href=../nctr_results.php?f="+feature.properties.Foglio+"&m="+feature.properties.Mappale+" target=_blank> NCTR </a></b>"
                + "<br><b><a href=../nceu_results.php?id="+feature.properties.idImm+" target=_blank> visura NCEU </a></b>";
            layer.bindPopup(popupText); 
            layer.on({mouseover: highlightFeature,mouseout: resetHighlight,click: zoomToFeature});
            }
           });
        map.fitBounds(mygeojson.getBounds());
        mygeojson.addTo(map);
      }

      document.getElementById('export').onclick = function(e) {
          // Extract GeoJson from dataLayer
          var data = mygeojson.toGeoJSON();
          var convertedData = 'text/json;charset=utf-8,' + encodeURIComponent(JSON.stringify(data));
          document.getElementById('export').setAttribute('href', 'data:' + convertedData);          
          document.getElementById('export').setAttribute('download','estr_ct_opencatamap.geojson');
        }

var info = L.control();

info.onAdd = function (map) {
    this._div = L.DomUtil.create('div', 'info'); // create a div with a class "info"
    this.update();
    return this._div;
};
    
    
 // method that we will use to update the control based on feature properties passed
info.update = function (props) {
    this._div.innerHTML = '<h4>Foglio/mappale</h4>' +  (props ?
        'Foglio <b>' + props.Foglio + '</b><br /> mappale ' + props.Mappale 
        : 'Passa mouse su mappale');
};

info.addTo(map);


// get color in dipendenza del valore (foglio)
    function getColor(d) {
        return d > 25 ? '#800026' :
        d > 24  ? '#BD0026' :
        d > 23  ? '#E31A1C' :
        d > 22  ? '#FC4E2A' :
        d > 21  ? '#FD8D3C' :
        d > 20  ? '#FEB24C' :
        d > 19  ? '#FED976' :
        d > 18  ? '#BD0026' :
        d > 17  ? '#E31A1C' :
        d > 16  ? '#FC4E2A' :
        d > 15  ? '#FD8D3C' :
        d > 14  ? '#FEB24C' :
        d > 13  ? '#FED976' :
        d > 12  ? '#BD0026' :
        d > 11  ? '#E31A1C' :
        d > 10  ? '#FC4E2A' :
        d > 9   ? '#FD8D3C' :
        d > 8   ? '#FEB24C' :
        d > 7   ? '#FED976' :
        d > 6   ? '#BD0026' :
        d > 4   ? '#E31A1C' :
        d > 4   ? '#FC4E2A' :
        d > 2   ? '#FD8D3C' :
        d > 2   ? '#FEB24C' :
        d > 1   ? '#1E90FF' :
        '#FFFF99';
    }




    function style(feature) {
        return {
            weight: 1,
            opacity: 1,
            color: 'black',
            //dashArray: '3',
            fillOpacity: 0.2,
            fillColor: getColor(feature.properties.Foglio)
        };
    }

    function highlightFeature(e) {
        var layer = e.target;
        layer.setStyle({
            weight: 1,
            color: 'red',
            dashArray: '3',
            fillColor: 'red',
            fillOpacity: 0.2
        });

        if (!L.Browser.ie && !L.Browser.opera && !L.Browser.edge) {
            layer.bringToFront();
        }

        info.update(layer.feature.properties);
    }


    function resetHighlight(e) {
        mygeojson.resetStyle(e.target);
        info.update();
    }

    function zoomToFeature(e) {
        map.fitBounds(e.target.getBounds());
    }

    function onEachFeature(feature, layer) {
        layer.on({
            mouseover: highlightFeature,
            mouseout: resetHighlight,
            click: zoomToFeature
        });
    }   

</script>


</body>
</html>

